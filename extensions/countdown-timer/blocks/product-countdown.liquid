
<div 
  class="countdown-widget-container"
  data-countdown-widget
  data-store="{{ shop.permanent_domain }}" 
  data-product-id="{{ product.id }}"
  data-api-url=""
  data-widget-url=""
  {{ block.shopify_attributes }}
>
  <div class="countdown-loading">
    <div class="loading-spinner"></div>
    <p>{{ block.settings.loading_text | default: 'Loading countdown timer...' }}</p>
  </div>
</div>

<script>
  (function() {
    if (window.countdownWidgetLoaded) return;
    
    function getAppUrls() {
      const customApiUrl = '{{ block.settings.custom_api_url }}';
      const customWidgetUrl = '{{ block.settings.custom_widget_url }}';
      
      if (customApiUrl && customWidgetUrl) {
        return {
          apiUrl: customApiUrl,
          widgetUrl: customWidgetUrl
        };
      }
      
      const currentHost = window.location.hostname;
      const isLocalDev = currentHost.includes('localhost') || currentHost.includes('127.0.0.1');
      const isShopifyPreview = currentHost.includes('myshopify.com');
      
      let apiUrl = 'https://your-production-app.com';
      let widgetUrl = 'https://your-production-app.com/widgets/countdown-widget.iife.js';
      
      if (isLocalDev || window.location.search.includes('preview_theme')) {
        const devConfig = document.querySelector('meta[name="app-dev-config"]');
        if (devConfig) {
          const config = JSON.parse(devConfig.content);
          apiUrl = config.apiUrl;
          widgetUrl = config.widgetUrl;
        } else {
          apiUrl = window.CountdownDevConfig?.apiUrl || 'https://your-dev-tunnel.ngrok.io';
          widgetUrl = window.CountdownDevConfig?.widgetUrl || 'https://your-dev-tunnel.ngrok.io/widgets/countdown-widget.iife.js';
        }
      }
      
      return { apiUrl, widgetUrl };
    }
    
    const urls = getAppUrls();
    
    document.querySelectorAll('[data-countdown-widget]').forEach(widget => {
      widget.setAttribute('data-api-url', urls.apiUrl);
      widget.setAttribute('data-widget-url', urls.widgetUrl);
    });
    
    const script = document.createElement('script');
    script.src = urls.widgetUrl;
    script.async = true;
    
    script.onload = function() {
      window.countdownWidgetLoaded = true;
      console.log('Countdown widget loaded from:', urls.widgetUrl);
      
      document.querySelectorAll('.countdown-loading').forEach(el => {
        el.style.display = 'none';
      });
    };
    
    script.onerror = function() {
      console.error('Failed to load countdown widget from:', urls.widgetUrl);
      document.querySelectorAll('[data-countdown-widget]').forEach(container => {
        container.innerHTML = '<div class="countdown-error">Unable to load countdown timer. Please check configuration.</div>';
      });
    };
    
    document.head.appendChild(script);
  })();
</script>

<style>
  .countdown-widget-container {
    margin: 15px 0;
  }
  
  .countdown-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    min-height: 60px;
  }
  
  .loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #e3e3e3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .countdown-loading p {
    margin: 0;
    color: #6c757d;
    font-size: 14px;
  }
  
  .countdown-error {
    padding: 15px;
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
    text-align: center;
    font-size: 14px;
  }
</style>

{% schema %}
{
  "name": "Countdown Timer (Auto-Config)",
  "target": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "This countdown timer automatically detects your app URLs. No configuration needed for most users!"
    },
    {
      "type": "text",
      "id": "loading_text",
      "label": "Loading message",
      "default": "Loading countdown timer..."
    },
  ],
  "presets": [
    {
      "name": "Countdown Timer"
    }
  ]
}
{% endschema %}